{% extends 'base.html' %}

{% block title %} User Dashboard {% endblock %}

{% block content %}

<div class="containe-fluid px-5 mt-4">
    <h2 class="mb-4 text-center">Welcome, {{ user.username }}!</h2>
    <br>
    <div class="row">

        <!-- left column: sidebar -->
        <div class="col-md-3 mb-3">
            <div class="sidebar-box">
                <div class="list-group">
                    <a href="#" class="list-group-item list-group-item-action active" id="showUpcoming"><i class='bx bxs-right-arrow'></i>  Upcoming Journeys</a>
                    <a href="#" class="list-group-item list-group-item-action" id="showPublished"><i class='bx bxs-right-arrow'></i>  Your Published Rides</a>
                    <a href="#" class="list-group-item list-group-item-action" id="showSavedCards"><i class='bx bxs-right-arrow'></i>  Your Saved Cards</a>
                    <a href="#" class="list-group-item list-group-item-action" id="showEarnings"><i class='bx bxs-right-arrow'></i>  Your Earnings</a>
                </div>
            </div>
        </div>
        
        <!-- right column: content area -->
        <div class="col-md-9">

            <!-- upcoming journeys section -->
            <div id="upcomingSection" class="mb-4">
                <h4>Upcoming Journeys</h4>
                {% if upcoming_journeys %}
                    <p class="text-muted mb-4">
                        Here's all your scheduled rides! Track your active journeys and pickup locations, or cancel ride. <br>
                        Please note that all cancellations after 15 minutes before the ride start time will result in a 75% cancellation fee, 
                        as per company policy!
                    </p>
                    <br>
                    <div class="row">
                        {% for journey in upcoming_journeys %}
                        <div class="col-md-4 mb-3">
                            <div class="card p-3">
                                <h5 class="card-title">{{ journey.from.split(',')[0] }} ➝ {{ journey.to.split(',')[0] }}</h5>
                                <p class="detail-item"><span class="detail-heading">Date:</span> {{ journey.date }}</p>
                                <p class="detail-item"><span class="detail-heading">Seats Booked:</span> {{ journey.seats_booked }}</p>
                                <p class="detail-item"><span class="detail-heading">Time:</span> {{ journey.time }}</p>
                                <p class="detail-item"><span class="detail-heading">Price:</span> £{{ journey.price }}</p>
                                <p class="detail-item"><span class="detail-heading">Category:</span> {{ journey.category }}</p>
                                <div class="text-center mt-3">
                                    {% if journey.status == "Booked" %}
                                        <button class="btn btn-base btn-red cancel-btn btn-block" data-booking-id="{{ journey.booking_id }}" 
                                                data-price="{{ journey.price }}" data-date="{{ journey.date }}" data-time="{{ journey.time }}">
                                            Cancel
                                        </button>
                                        {% if journey.category == "one-time" %}
                                            <a href="{{ url_for('view_pickup', ride_id=journey.ride_id) }}" class="btn btn-base btn-one mt-2 btn-block">
                                                View Pickup Location
                                            </a>
                                        {% elif journey.category == "commuting" %}
                                            <a href="{{ url_for('view_pickup_commute', ride_id=journey.ride_id, date=journey.date) }}" class="btn btn-base btn-one mt-2 btn-block">
                                                View Pickup Location
                                            </a>
                                        {% endif %}
                                        <!-- chat button -->
                                        <a href="{{ url_for('chat_view', booking_id=journey.booking_id) }}" class="btn btn-base btn-one btn-chat mt-2 btn-block">
                                            Chat with driver
                                        </a>
                                        
                                        {% if journey.accepted_proposals and journey.accepted_proposals|length > 0 %}
                                            <!-- modal button -->
                                            <button class="btn btn-base btn-one btn-chat mt-2 btn-block" data-bs-toggle="modal" data-bs-target="#editModal{{ journey.booking_id }}">
                                                View Booking Changes
                                            </button>

                                            <!-- modal -->
                                            <div class="modal fade" id="editModal{{ journey.booking_id }}" tabindex="-1" aria-labelledby="editModalLabel{{ journey.booking_id }}" aria-hidden="true">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title" id="editModalLabel{{ journey.booking_id }}">Accepted Booking Changes</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                                                            {% for proposal in journey.accepted_proposals %}
                                                                <div class="mb-3 border-bottom pb-2">
                                                                    {% if proposal.timestamp %}<p class="mb-1 text-muted"><em>Accepted on {{ proposal.timestamp }}</em></p>{% endif %}
                                                                    {% if proposal.pickup %}<p><strong>Pickup:</strong> {{ proposal.pickup }}</p>{% endif %}
                                                                    {% if proposal.time %}<p><strong>Time:</strong> {{ proposal.time }}</p>{% endif %}
                                                                    {% if proposal.cost is not none %}<p><strong>Cost:</strong> £{{ proposal.cost }}</p>{% endif %}
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}


                                    {% else %}
                                        <span class="text-muted">Canceled</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">
                        No upcoming journeys booked. Wanna find a ride? <a href="{{ url_for('view_journeys') }}">Book here.</a>
                    </p>
                {% endif %}
                <!-- toggle inactive bookings button -->
                <div class="text-center mt-4">
                    <button class="btn btn-base btn-one btn-block" id="toggleInactive">Show Inactive Bookings</button>
                </div>
            </div>

            <!-- inactive bookings section hidden -->
            <div id="inactiveSection" class="mb-4" style="display: none;">
                <h4>Inactive Bookings</h4>
                {% if inactive_journeys %}
                <p class="text-muted mb-4">
                    These bookings have been either finished or cancelled. To rebook, head to <a href="{{ url_for('view_journeys') }}">Find a Ride</a> to check availability.
                </p>
                    <div class="row">
                        {% for journey in inactive_journeys %}
                        <div class="col-md-4 mb-3">
                            <div class="card p-3">
                                <h5 class="card-title">{{ journey.from.split(',')[0] }} ➝ {{ journey.to.split(',')[0] }}</h5>
                                <p class="detail-item"><span class="detail-heading">Date:</span> {{ journey.date }}</p>
                                <p class="detail-item"><span class="detail-heading">Seats Booked:</span> {{ journey.seats_booked }}</p>
                                <p class="detail-item"><span class="detail-heading">Time:</span> {{ journey.time }}</p>
                                <p class="detail-item"><span class="detail-heading">Price:</span> £{{ journey.price }}</p>
                                <p class="detail-item {% if journey.status == 'done' %}text-success{% elif journey.status == 'Canceled' %}text-danger{% endif %}">
                                    <span class="detail-heading">Status:</span> 
                                    <span id="status-{{ journey.ride_id }}">
                                        {% if journey.status == 'done' %}Finished
                                        {% elif journey.status == 'Canceled' %}Canceled
                                        {% else %}{{ journey.status }}
                                        {% endif %}
                                    </span>
                                </p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No inactive bookings.</p>
                {% endif %}
            </div>
            
            <!-- published rides section -->
            <div id="publishedSection" class="mb-4" style="display: none;">
                <h4>Your Published Rides</h4>
                <p class="text-muted mb-4">
                    Here's all the rides you've published! Select 'View Passengers' in the Commuting Rides section to see everyone who's booked your ride!
                </p>
                <br>
                <!-- one time journeys -->
                <h5>One-Time Journeys</h5>
                {% if published_rides.one_time %}
                    <div class="row">
                        {% for ride in published_rides.one_time %}
                        <div class="col-md-4 mb-3">
                            <div class="card p-3">
                                <h5 class="card-title">{{ ride.from.split(',')[0] }} ➝ {{ ride.to.split(',')[0] }}</h5>
                                <p class="detail-item"><span class="detail-heading">Date:</span> {{ ride.date }}</p>
                                <p class="detail-item"><span class="detail-heading">Time:</span> {{ ride.time }}</p>
                                <p class="detail-item"><span class="detail-heading">Price:</span> £{{ ride.price }}</p>
                               
                                <div class="text-center mt-3">
                                    <!-- modal button -->
                                    <button class="btn btn-base btn-one btn-block mt-3 mb-2" data-bs-toggle="modal" data-bs-target="#chatModal{{ ride.ride_id }}">
                                        Chat with Passengers
                                    </button>
                                    <!-- chat options modal -->
                                    <div class="modal fade" id="chatModal{{ ride.ride_id }}" tabindex="-1" aria-labelledby="chatModalLabel{{ ride.ride_id }}" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-scrollable">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="chatModalLabel{{ ride.ride_id }}">
                                                        Chat with Passengers for {{ ride.from.split(',')[0] }} ➝ {{ ride.to.split(',')[0] }}
                                                    </h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    {% if ride.passengers %}
                                                        {% for passenger in ride.passengers %}
                                                            <a href="{{ url_for('chat_view', booking_id=passenger.booking_id) }}" class="btn btn-base btn-one btn-chat btn-block mb-2">
                                                                Chat with {{ passenger.name }}
                                                            </a>
                                                        {% endfor %}
                                                    {% else %}
                                                        <p class="text-muted">No passengers yet.</p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                     <!-- track button -->
                                    <a href="{{ url_for('view_pickup', ride_id=ride.ride_id) }}" class="btn btn-base btn-one btn-block mb-2">
                                        Track Passengers
                                    </a>
                                    <!-- view booking changes button for all passengers -->
                                    <button class="btn btn-base btn-one btn-block mb-2" data-bs-toggle="modal" data-bs-target="#editModalOneTime{{ ride.ride_id }}">
                                        View Booking Changes
                                    </button>
                                </div>

                                <!-- modal for all combined edit changes -->
                                <div class="modal fade" id="editModalOneTime{{ ride.ride_id }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-scrollable">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Booking Changes for {{ ride.from.split(',')[0] }} → {{ ride.to.split(',')[0] }}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                                                {% set ns = namespace(has_changes=false) %}
                                                {% for passenger in ride.passengers %}
                                                    {% if passenger.accepted_proposals and passenger.accepted_proposals | length > 0 %}

                                                        {% set ns.has_changes = true %}
                                                        <div class="mb-3 border-bottom pb-2">
                                                            <strong>{{ passenger.name }}</strong><br>
                                                            {% for proposal in passenger.accepted_proposals %}
                                                                <p class="mb-1 text-muted"><em>Accepted on {{ proposal.timestamp }}</em></p>
                                                                {% if proposal.pickup %}
                                                                    <p><strong>Pickup:</strong> {{ proposal.pickup }}</p>
                                                                {% endif %}
                                                                {% if proposal.time %}
                                                                    <p><strong>Time:</strong> {{ proposal.time }}</p>
                                                                {% endif %}
                                                                {% if proposal.cost is not none %}
                                                                    <p><strong>Cost:</strong> £{{ proposal.cost }}</p>
                                                                {% endif %}
                                                                <hr>
                                                            {% endfor %}
                                                        </div>
                                                    
                                                    {% endif %}
                                                {% endfor %}
                                                {% if not ns.has_changes %}
                                                    <p class="text-muted">No booking changes to show.</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No one-time journeys published.</p>
                {% endif %}
                
                <!-- commuting journeys -->
                <h5 class="mt-4">Commuting Journeys</h5>
                {% if published_rides.commuting %}
                    <div class="row">
                        {% for ride in published_rides.commuting %}
                        <div class="col-md-4 mb-3">
                            <div class="card p-3">
                                <h5 class="card-title">{{ ride.from.split(',')[0] }} ➝ {{ ride.to.split(',')[0] }}</h5>
                                <p class="detail-item"><span class="detail-heading">Time:</span> {{ ride.time }}</p>
                                <p class="detail-item"><span class="detail-heading">Price per Seat:</span> £{{ ride.price }}</p>
                                
                                <button class="btn-base btn-one mt-3" data-bs-toggle="collapse" data-bs-target="#rideDates{{ ride.ride_id }}" aria-expanded="false">
                                    View Passengers
                                </button>
                                <div class="collapse mt-2" id="rideDates{{ ride.ride_id }}">
                                    {% if ride.dates %}
                                    <ul class="list-group">
                                        {% for date, passengers in ride.dates.items() %}
                                        <li class="list-group-item p-0 d-flex justify-content-between align-items-center">
                                            <button class="btn-base btn-one btn-block flex-grow-1 mb-2" data-bs-toggle="modal" data-bs-target="#passengerModalCommute{{ ride.ride_id }}_{{ date }}">
                                                {{ date }}
                                            </button>
                                            
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    {% else %}
                                    <p class="text-muted mb-0">No passengers yet.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- passenger modals for each date -->
                        {% for date, passengers in ride.dates.items() %}
                        <div class="modal fade" id="passengerModalCommute{{ ride.ride_id }}_{{ date }}" tabindex="-1" aria-labelledby="passengerModalLabelCommute{{ ride.ride_id }}_{{ date }}" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">{{ ride.from.split(',')[0] }} ➝ {{ ride.to.split(',')[0] }}, {{ date }}</h5>
                                    </div>
                                    <div class="modal-body">
                                        {% if passengers %}
                                            <a href="{{ url_for('view_pickup_commute', ride_id=ride.ride_id, date=date) }}" class="btn btn-base btn-one btn-block mb-3">
                                                Track Pickup
                                            </a>
                                            <!-- view all booking changes button -->
                                            <button class="btn btn-base btn-one btn-block mb-3" data-bs-toggle="modal" data-bs-target="#combinedChangesModal{{ ride.ride_id }}_{{ date }}">
                                                View Booking Changes
                                            </button>
                                            {% for passenger in passengers %}
                                                <a href="{{ url_for('chat_view', booking_id=passenger.booking_id) }}" class="btn btn-base btn-one btn-chat mt-2 btn-block">
                                                    Chat with {{ passenger.name }}
                                                </a>
                                            {% endfor %}
                                        {% else %}
                                            <p class="text-muted">No passengers yet.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- combined modal: all booking changes for this date -->
                        <div class="modal fade" id="combinedChangesModal{{ ride.ride_id }}_{{ date }}" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-scrollable">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Booking Changes for {{ ride.from.split(',')[0] }} → {{ ride.to.split(',')[0] }}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                                        {% set ns = namespace(has_changes=false) %}
                                        {% for passenger in passengers %}
                                            {% if passenger.accepted_proposals and passenger.accepted_proposals | length > 0 %}

                                                {% set ns.has_changes = true %}
                                                <div class="mb-3 border-bottom pb-2">
                                                    <strong>{{ passenger.name }}</strong><br>
                                                    {% for proposal in passenger.accepted_proposals %}
                                                        <p class="mb-1 text-muted"><em>Accepted on {{ proposal.timestamp }}</em></p>
                                                        {% if proposal.pickup %}
                                                            <p><strong>Pickup:</strong> {{ proposal.pickup }}</p>
                                                        {% endif %}
                                                        {% if proposal.time %}
                                                            <p><strong>Time:</strong> {{ proposal.time }}</p>
                                                        {% endif %}
                                                        {% if proposal.cost is not none %}
                                                            <p><strong>Cost:</strong> £{{ proposal.cost }}</p>
                                                        {% endif %}
                                                        <hr>
                                                    {% endfor %}
                                                </div>
                                            
                                            {% endif %}
                                        {% endfor %}

                                        {% if not ns.has_changes %}
                                            <p class="text-muted">No booking changes to show.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No commuting journeys published.</p>
                {% endif %}
            </div>

            <!-- saved cards section -->
            <div id="savedCardsSection" class="mb-4" style="display: none;">
                <h4>Your Saved Cards</h4><br>
                {% if user.saved_cards %}
                    <ul class="list-group">
                        {% for card in user.saved_cards %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>**** **** **** {{ card.last_four_digits }} <br> Exp: {{ card.expiry_date }}</span>
                            <button class="btn delete-card-btn" data-card-id="{{ card.id }}"><i class='bx bx-trash'></i></button>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">No saved cards.</p>
                {% endif %}
            </div>
            
            <!-- driver earnings section -->
            <div id="earningsSection" class="mb-4" style="display: none;">
                {% if earnings_data %}
                    <!-- earnings highlight block -->
                    <div class="text-center mb-5">
                        <h4>Wowie! You've earned a total of
                            <br><span id="totalEarnings" data-total="{{ total_earnings }}" class="earnings-number">
                                £{{ "%.2f"|format(total_earnings) }}
                            </span><br>
                        with CatchMyRide!</h4>
                    </div>
                    <hr>
                    <h4>Your Weekly Earnings</h4>
                    <!-- graphical view -->
                    <p class="text-muted">Here's a graphical view of your net earnings (after 0.5% platform fee), grouped by week:</p>
                    <div class="chart-container">
                        <canvas id="earningsChart"
                                data-labels='{{ earnings_data|map(attribute=0)|list|tojson }}'
                                data-values='{{ earnings_data|map(attribute=1)|list|tojson }}'
                                data-dates='{{ earnings_data|map(attribute=2)|list|tojson }}'>
                        </canvas>
                    </div>
                    <!-- detailed table view of driver earnings -->
                    <p class="text-muted">Here's the full table for all your earnings per week so far:</p>
                    <div class="table-responsive">
                        <table class="table earnings-table">
                            <thead>
                                <tr>
                                    <th>Week</th>
                                    <th>Dates</th>
                                    <th>Total Earnings (£)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for week, amount, date_range in earnings_data %}
                                    <tr>
                                        <td>{{ week }}</td>
                                        <td><strong>{{ date_range }}</td>
                                        <td>£{{ "%.2f"|format(amount) }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No earnings to show yet.</p>
                {% endif %}
            </div>

        </div>
    </div>
</div>

{% endblock %}
